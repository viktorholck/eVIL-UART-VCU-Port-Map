version: 3
# pip install go-task-bin
tasks:
  build:
    desc: Build all the executables for the project
    cmds:
      - task: .build:scripts
        vars:
          scripts: "UARTVCUPortMap.py testPortMap.py"
  
  build:UARTVCUPortMap:
    desc: Build the executable for UARTVCUPortMap
    cmds:
      - task: .build:scripts
        vars: 
          scripts: 'UARTVCUPortMap.py'
  
  build:testPortMap:
    desc: Build the executable for testPortMap
    cmds:
      - task: .build:scripts
        vars: 
          scripts: 'testPortMap.py'

  .build:scripts:
    internal: true
    desc: Build multiple scripts in a single invocation (uses generateExecutable.py nargs='+')
    cmds:
      - uv run generateExecutable.py --script {{.scripts}}
    deps:
      - task: venv
      - task: devcontainer:build

  devcontainer:build:
    desc: Build the devcontainer image if needed (devcoontainer.json/Dockerfile changed or any file in .devcontainer/)
    cmds:
      - cmd: 'devcontainer build --workspace-folder . --no-cache'
    sources:
      - .devcontainer/**
  
  devcontainer:build-force:
    desc: Build the devcontainer image (force rebuild) even if nothing has changed (devcoontainer.json/Dockerfile/.devcontainer/)
    cmds:
      - cmd: 'devcontainer build --workspace-folder . --no-cache'

  venv:
    desc: Create a virtual environment
    cmds:
      # - uv add -r requirements.txt
      - uv sync
      # - python -m venv .venv
      # - .venv\\Scripts\\activate.bat
      # - pip install -r requirements.txt
    status:
      # - python -c "import sys, os; print('Virtual environment is active' if os.path.basename(sys.prefix) == '.venv' else 'Virtual environment is NOT active'); exit(0 if os.path.basename(sys.prefix) == '.venv' else 1)"
  
  venv:activate:
    desc: Activate the virtual environment
    cmds:
      - .venv\\Scripts\\activate.bat
    status:
      - python -c "import sys, os; print('Virtual environment is active' if os.path.basename(sys.prefix) == '.venv' else 'Virtual environment is NOT active'); exit(0 if os.path.basename(sys.prefix) == '.venv' else 1)"

  clean:
    desc: Clean the project
    cmds:
      - cmd: deactivate
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force *.spec -ErrorAction SilentlyContinue"
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue"
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force buildLinux -ErrorAction SilentlyContinue"
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force buildWindows -ErrorAction SilentlyContinue"
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force .venv -ErrorAction SilentlyContinue"
        ignore_error: true
      - cmd: powershell -Command "Remove-Item -Recurse -Force .venv_devcontainer -ErrorAction SilentlyContinue"
        ignore_error: true